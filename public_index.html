<html>
<head>
    <script src="./underscore.js"></script>
</head>
<body>
    <script>
        sentences = [
            "More sentences will make the Markov chains better",
            "Better code would also make the Markov chains better",
            "Where there is a will there is a way",
            "Never look a gift horse in the mouth",
            "I swear that has never happened before",
            "This parrot is dead",
            "This is an ex parrot",
            "Once upon a midnight dreary while I pondered weak and weary over many a quaint and curious volume of forgotten lore",
            "What is the air-speed velocity of an unladen swallow",
        ];

        twoGrams = {};
        threeGrams = {};

        pickNextWordFromArray = function(ra) {
            var w = ra[parseInt(Math.random() * ra.length)];
            return w;
        };

        getProbabilities = function() {
            _(sentences).each(function(sentence) {
                words = sentence.split(' ');

                for (var i = 0; i < words.length - 1; i++) {
                    var word0 = words[i].toLowerCase();
                    if (!twoGrams[word0]) {
                        twoGrams[word0] = [words[i+1].toLowerCase()];
                    } else {
                        var word1 = words[i+1].toLowerCase();
                        twoGrams[word0].push(word1);
                    }
                };

                for (var i = 0; i < words.length - 2; i++) {
                    var word0 = words[i].toLowerCase();
                    var word1 = words[i+1].toLowerCase();
                    var word2 = words[i+2].toLowerCase();

                    var indexer = Array(word0, word1).join(' ');
                    if (!threeGrams[indexer]) {
                        threeGrams[indexer] = [word2];
                    } else {
                        threeGrams[indexer].push(word2);
                    }
                };
            });
        };

        // if first word, pick from twoGrams
        // if >1st word, pick from threeGrams unless there is no threeGram
        //      in which case, pick from twoGrams unless there is no twoGrams
        //      in which case, pick randomly.

        makeSentence = function(word) {
            getProbabilities();
            if (!!word) {
                sentence = [word, pickNextWordFromArray(twoGrams[word])];
            } else {
                word = pickNextWordFromArray(_(twoGrams).keys());
                sentence = [word, pickNextWordFromArray(twoGrams[word])];
            }

            for (var i = 0; i < 10 + Math.random() * 20; i++) {
                var indexer = sentence.slice(-2).join(' ');
                if (!!threeGrams[indexer]) {
                    sentence.push(pickNextWordFromArray(threeGrams[indexer]));
                } else if (!!twoGrams[sentence.slice(-1)[0]]) {
                    sentence.push(pickNextWordFromArray(twoGrams[sentence.slice(-1)[0]]));
                } else {
                    break;
                }

            };
            return sentence.join(' ');
        }

    </script>
</body>
</html>
